---
import Layout from "@/layouts/Layout.astro";
import { AstroReaderWrapper } from "@/components/AstroReaderWrapper";
import { getMangaById, getChapterIdByNumber, getChapterPages } from "@/lib/mangadex";

// Enable SSR for dynamic routing
export const prerender = false;

const { id, chapterId } = Astro.params;

if (!id || !chapterId) {
  return Astro.redirect("/404");
}

const currentChNum = parseFloat(chapterId) || 1;

// Fetch data on the server
const [manga, realChapterId] = await Promise.all([
  getMangaById(id),
  getChapterIdByNumber(id, chapterId),
]);

if (!manga) {
  return Astro.redirect("/404");
}

let pages: string[] = [];
if (realChapterId) {
  pages = await getChapterPages(realChapterId);
}

const title = `Reading ${manga.title} - Chapter ${chapterId}`;
---

<Layout title={title}>
  <AstroReaderWrapper
    client:only="react"
    manga={manga}
    chapterId={chapterId}
    currentChNum={currentChNum}
    pages={pages}
  />
</Layout>
